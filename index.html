<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TSV Unterpfaffenhofen ‚Äì Spielpl√§ne G1/G2/G3</title>
<meta name="description" content="Aktuelle Spielpl√§ne der Kegel-Teams G1, G2 und G3 des TSV Unterpfaffenhofen f√ºr die Saison 2025/26">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='8' fill='%230056b3'/%3E%3Ctext x='50%' y='54%' font-family='Arial' font-weight='700' font-size='28' fill='white' text-anchor='middle'%3ETSV%3C/text%3E%3C/svg%3E">

<style>
  :root{
    --tsv-blue:#0056b3;
    --tsv-blue-dark:#004494;
    --bg:#f5f7fb;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --success:#16a34a;
    --danger:#dc2626;
    --shadow:0 2px 6px rgba(0,0,0,.06);
    --transition:.2s ease;
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;scroll-behavior:smooth}
  
  /* Loading */
  .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity var(--transition)}
  .loading-overlay.hidden{opacity:0;pointer-events:none}
  .spinner{width:40px;height:40px;border:4px solid var(--line);border-top-color:var(--tsv-blue);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

  /* Error */
  .error-message{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:12px;border-radius:8px;margin-bottom:14px;display:none}

  /* Topbar */
  .topbar{background:linear-gradient(135deg,var(--tsv-blue),var(--tsv-blue-dark));color:#fff;box-shadow:var(--shadow)}
  .topbar .wrap{max-width:1300px;margin:0 auto;padding:16px 20px;display:flex;gap:14px;align-items:center}
  .topbar img{height:44px;background:#fff;border-radius:8px;padding:4px;transition:transform var(--transition)}
  .topbar img:hover{transform:scale(1.05)}
  .title{font-weight:800;font-size:clamp(1.4rem,3.2vw,2.2rem);line-height:1.15;text-shadow:0 1px 2px rgba(0,0,0,.1)}

  .container{max-width:1300px;margin:0 auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-bottom:14px;transition:box-shadow var(--transition)}

  /* Filter */
  .filters{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;margin-bottom:12px;align-items:end}
  .filters > *{min-width:0}
  .filters label{font-size:.85rem;color:var(--muted);display:block;margin:0 0 6px;font-weight:600}
  .filters select,.filters input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;transition:border-color var(--transition),box-shadow var(--transition)}
  .filters select:focus,.filters input[type="text"]:focus{outline:none;border-color:var(--tsv-blue);box-shadow:0 0 0 3px rgba(0,86,179,.1)}
  .filters .toggle{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;transition:background-color var(--transition)}
  .filters .toggle:hover{background:#f8fafc}
  .filters .toggle input{transform:scale(1.2)}

  /* Suche (fix) */
  .search-container{position:relative;z-index:1}
  .search-container .field{position:relative;width:100%;display:block}
  .filters .search-input{padding-left:40px!important}
  .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
  .search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:none;background:transparent;color:var(--muted);padding:4px 6px;border-radius:4px;opacity:0;transition:opacity var(--transition)}
  .search-clear:hover{background:#f3f4f6;color:var(--text)}

  /* Chips & misc */
  .chip{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid var(--line);background:#f8fafc}
  .chip-heim{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .chip-auswaerts{background:#eff6ff;border-color:#bfdbfe;color:#1e3a8a}
  .ms-badge{margin-left:8px;background:#111827;color:#fff;display:inline-flex;align-items:center;justify-content:center;border-radius:4px;font-size:.7rem;min-width:22px;height:22px}
  .ms-badge.two{background:#0ea5e9}

  /* Quick filters */
  .quick-filters{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .quick-filter{padding:6px 12px;border-radius:20px;border:1px solid var(--line);background:#fff;color:#111827;font-size:.85rem;cursor:pointer;transition:all var(--transition)}
  .quick-filter:hover{background:#f3f4f6}
  .quick-filter.active{background:var(--tsv-blue);color:#fff;border-color:var(--tsv-blue)}

  /* Stats */
  .stats{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .stat{background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:8px 12px;text-align:center;min-width:100px}
  .stat-value{font-size:1.2rem;font-weight:800;color:var(--tsv-blue)}
  .stat-label{font-size:.8rem;color:var(--muted);margin-top:2px}

  /* Aktionen */
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid var(--line);background:#fff;color:#111827;cursor:pointer;transition:all var(--transition);text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  .btn:hover{background:#f3f4f6;transform:translateY(-1px);box-shadow:var(--shadow)}
  .btn-primary{background:var(--tsv-blue);color:#fff;border-color:var(--tsv-blue)}
  .btn-primary:hover{background:var(--tsv-blue-dark)}

  /* Tabelle */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;max-height:70vh}
  table{width:100%;border-collapse:collapse;min-width:1000px}
  thead th{font-size:.8rem;color:var(--muted);font-weight:700;text-align:left;padding:10px 12px;background:#f8fafc;border-bottom:1px solid var(--line);user-select:none;transition:background-color var(--transition)}
  thead th:hover{background:#f0f0f0}
  thead th.sortable::after{content:' ‚áÖ';opacity:.5;font-size:.7rem}
  thead th.sort-asc::after{content:' ‚Üë';opacity:1;color:var(--tsv-blue)}
  thead th.sort-desc::after{content:' ‚Üì';opacity:1;color:var(--tsv-blue)}
  
  tbody td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle;transition:background-color var(--transition)}
  tbody tr:hover{background:#f9fafb}
  tbody tr.month-sep td{border-top:3px solid #111827}

  .date-cell .chev{opacity:.5;margin-right:.5rem}
  .club-cell{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .wd-cell,.time-cell,.liga-cell{white-space:nowrap}

  /* Roster */
  .roster summary{font-weight:700;cursor:pointer}
  .roster-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .roster-team{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
  .roster-team h3{margin:6px 0 8px}

  /* Responsive */
  @media (max-width:1100px){
    .filters{grid-template-columns:repeat(3,minmax(0,1fr))}
  }
  @media (max-width:760px){
    .filters{grid-template-columns:repeat(1,minmax(0,1fr))}
    .filters .search-container{grid-column:1/-1}
    table{min-width:680px}
    .actions .btn{flex:1 1 auto}
    .roster-grid{grid-template-columns:1fr}
    .stats{justify-content:center}
    #games th:nth-child(2),#games td:nth-child(2){display:none}
    td.club-cell{max-width:clamp(160px,40vw,360px)}
    .expand-box{grid-template-columns:1fr}
    .quick-filters{justify-content:center}
  }

  /* Print */
  @media print{
    .topbar,.filters,.actions,.quick-filters,.stats{display:none!important}
    .container{max-width:100%;padding:0}
    table{min-width:auto}
    tbody td{border:1px solid #999}
    tbody tr.month-sep td{border-top:3px solid #000}
    .loading-overlay{display:none!important}
  }
</style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="topbar">
    <div class="wrap">
      <img src="https://tsv-ug.de/wp-content/uploads/2024/02/tsv-logo.webp" alt="TSV UG" />
      <div class="title">TSV Unterpfaffenhofen ¬∑ Spielpl√§ne G1/G2/G3 (2025/26)</div>
    </div>
  </div>

  <div class="container">
    <section class="card">
      <div class="error-message" id="errorBox"></div>

      <div class="filters" id="filters">
        <div class="search-container">
          <label for="search">Suche</label>
          <div class="field">
            <span class="search-icon">üîç</span>
            <input type="text" id="search" class="search-input" placeholder="Gegner, Liga, Team...">
            <button class="search-clear" id="searchClear" aria-label="Eingabe l√∂schen">‚úï</button>
          </div>
        </div>
        <div>
          <label for="ha">Heim/Ausw√§rts</label>
          <select id="ha"><option value="">Alle</option><option value="Heim">Heim</option><option value="Ausw√§rts">Ausw√§rts</option></select>
        </div>
        <div>
          <label for="teamLiga">Mannschaft ¬∑ Liga</label>
          <select id="teamLiga"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="gegner">Gegner</label>
          <select id="gegner"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="weekday">Wochentag</label>
          <select id="weekday"><option value="">Alle</option><option>Mo</option><option>Di</option><option>Mi</option><option>Do</option><option>Fr</option><option>Sa</option><option>So</option></select>
        </div>
        <div class="toggle" onclick="document.getElementById('hidePast').click()">
          <input type="checkbox" id="hidePast" onclick="event.stopPropagation()" />
          <label for="hidePast" style="margin:0;cursor:pointer">Vergangene Spiele ausblenden</label>
        </div>
      </div>

      <div class="quick-filters" id="quickFilters">
        <button class="quick-filter" data-filter="today">Heute</button>
        <button class="quick-filter" data-filter="week">Diese Woche</button>
        <button class="quick-filter" data-filter="month">Dieser Monat</button>
        <button class="quick-filter" data-filter="home">Nur Heimspiele</button>
        <button class="quick-filter" data-filter="away">Nur Ausw√§rtsspiele</button>
      </div>

      <div class="stats" id="stats"></div>

      <div class="actions">
        <button class="btn btn-primary" id="btnPdf">üìÑ Als PDF</button>
        <button class="btn" id="btnIcs">üìÖ Kalender (ICS)</button>
        <button class="btn" id="btnExcel">üìä Excel Export</button>
        <button class="btn" id="btnReset">üîÑ Zur√ºcksetzen</button>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table id="games">
          <thead>
            <tr>
              <th class="sortable" data-sort="date">Datum</th>
              <th>Wochentag</th>
              <th class="sortable" data-sort="time">Uhrzeit</th>
              <th class="sortable" data-sort="team">Team</th>
              <th class="sortable" data-sort="home">Heim</th>
              <th></th>
              <th class="sortable" data-sort="away">Ausw√§rts</th>
              <th>TSV</th>
              <th class="sortable" data-sort="liga">Liga</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState" style="display:none;padding:18px;color:var(--muted)">Keine Spiele gefunden.</div>
    </section>

    <section class="card">
      <details class="roster" id="roster">
        <summary>Aktuelle Mannschaftsbesetzung</summary>
        <div class="roster-grid">
          <div class="roster-team">
            <h3>ü•á Team G1 (Kreisliga 2)</h3>
            <ul><li>Max Mustermann</li><li>Hans Schmidt</li><li>Peter Weber</li><li>Karl Huber</li><li>Josef Maier</li><li>Franz K√∂nig</li><li>Andreas Hofmann</li></ul>
          </div>
          <div class="roster-team">
            <h3>ü•à Team G2 (Kreisklasse 1)</h3>
            <ul><li>Andreas M√ºller</li><li>Stefan Wagner</li><li>Ralf Becker</li><li>Georg Lehmann</li><li>Frank Richter</li><li>Wolfgang Klein</li><li>Helmut Gro√ü</li></ul>
          </div>
          <div class="roster-team">
            <h3>ü•â Team G3 (Kreisklasse 2)</h3>
            <ul><li>Martin Hoffmann</li><li>J√ºrgen Schulz</li><li>Rainer Zimmermann</li><li>Dieter Braun</li><li>Bernd Hartmann</li><li>Uwe Lange</li></ul>
          </div>
        </div>
      </details>
    </section>
  </div>

<script>
  // ------ State Management ------
  const AppState = {
    data: [],
    filteredData: [],
    dateCount: {},
    currentSort: { field: 'date', direction: 'asc' },
    filters: {
      quick: '',
      ha: '',
      teamLiga: '',
      gegner: '',
      weekday: '',
      hidePast: false,
      search: ''
    }
  };

  // ------ Helpers ------
  const showError = (msg) => {
    const el = document.getElementById('errorBox');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => {
      el.style.display = 'none';
    }, 5000);
  };

  const hideLoading = () => {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('hidden');
    setTimeout(() => overlay.style.display = 'none', 200);
  };

  // ------ Mock Data Generator ------
  function generateMockData() {
    const teams = ['G1', 'G2', 'G3'];
    const opponents = [
      'SKV M√ºnchen', 'KC Starnberg', 'KSV Dachau', 'TSV Germering',
      'SKC Weilheim', 'KC F√ºrstenfeldbruck', 'KV Landsberg', 'TSV Herrsching',
      'SV Gilching', 'KC Pasing', 'TSV Gauting', 'KSV Planegg'
    ];
    const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    const ligas = { G1: 'Kreisliga 2', G2: 'Kreisklasse 1', G3: 'Kreisklasse 2' };
    const data = [];

    const startDate = new Date(2025, 7, 15); // 15. August 2025
    
    for (let i = 0; i < 60; i++) {
      const gameDate = new Date(startDate);
      gameDate.setDate(startDate.getDate() + (i * 7) + Math.floor(Math.random() * 3));
      
      const team = teams[i % 3];
      const opponent = opponents[i % opponents.length];
      const isHome = Math.random() > 0.5;
      const times = ['19:00', '19:30', '20:00'];
      
      data.push({
        Datum: gameDate.toISOString().split('T')[0],
        Wochentag: weekdays[gameDate.getDay() === 0 ? 6 : gameDate.getDay() - 1],
        Uhrzeit: times[Math.floor(Math.random() * times.length)],
        Team: team,
        Heim: isHome ? 'TSV Unterpfaffenhofen' : opponent,
        Ausw√§rts: isHome ? opponent : 'TSV Unterpfaffenhofen',
        'TSV Heim/Ausw√§rts': isHome ? 'Heim' : 'Ausw√§rts',
        Gegner: opponent,
        Liga: ligas[team]
      });
    }

    return data.sort((a, b) => new Date(a.Datum) - new Date(b.Datum));
  }

  // ------ Data Loading ------
  async function loadData() {
    try {
      // Hier sp√§ter per fetch echte Daten laden ‚Äì aktuell Dummy:
      const rows = generateMockData();
      AppState.data = rows;
      AppState.filteredData = rows;
      updateFiltersFromData(rows);
      render();
    } catch (e) {
      console.error(e);
      showError('Daten konnten nicht geladen werden.');
    } finally {
      hideLoading();
    }
  }

  function updateFiltersFromData(rows){
    // Team/Liga Kombos
    const combos = Array.from(new Set(rows.map(r => `${r.Team}|${r.Liga}`))).sort();
    const tl = document.getElementById('teamLiga');
    tl.innerHTML = '<option value="">Alle</option>' + combos.map(c => `<option value="${c}">${c.replace('|',' ¬∑ ')}</option>`).join('');
    // Gegner
    const sel = document.getElementById('gegner');
    const vals = Array.from(new Set(rows.map(r => r.Gegner).filter(Boolean))).sort();
    sel.innerHTML = '<option value="">Alle</option>' + vals.map(v => `<option>${v}</option>`).join('');
  }

  // ------ Formatting / Utils ------
  const fmtDE = (iso) => {
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    return `${d}.${m}.${y}`;
  };
  const parseISO = (iso, time = '00:00') => {
    const t = (time && /^\d{1,2}:\d{2}$/.test(time)) ? time : '00:00';
    return new Date(`${iso}T${t}`);
  };
  const monthKey = (iso) => {
    if (!iso) return '';
    const [y, m] = iso.split('-');
    return `${y}-${m}`;
  };
  const isToday = (iso) => {
    const today = new Date();
    const gameDate = new Date(iso);
    return today.toDateString() === gameDate.toDateString();
  };
  const debounce = (func, wait) => {
    let t; 
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,args), wait); };
  };

  // ------ Rendering ------
  function render() {
    AppState.filteredData = applyFilters();
    updateStats(AppState.filteredData);
    renderTable();
    updateURL();
  }

  function applySorting(rows) {
    const { field, direction } = AppState.currentSort;
    const copy = [...rows];
    return copy.sort((a, b) => {
      let aVal, bVal;
      switch (field) {
        case 'date': aVal = parseISO(a.Datum, a.Uhrzeit); bVal = parseISO(b.Datum, b.Uhrzeit); break;
        case 'time': aVal = a.Uhrzeit; bVal = b.Uhrzeit; break;
        case 'team': aVal = a.Team; bVal = b.Team; break;
        case 'home': aVal = a.Heim; bVal = b.Heim; break;
        case 'away': aVal = a.Ausw√§rts; bVal = b.Ausw√§rts; break;
        case 'liga': aVal = a.Liga; bVal = b.Liga; break;
        default: aVal = a.Datum; bVal = b.Datum;
      }
      if (aVal instanceof Date && bVal instanceof Date) return (direction==='asc') ? aVal-bVal : bVal-aVal;
      const cmp = String(aVal).localeCompare(String(bVal));
      return (direction==='asc') ? cmp : -cmp;
    });
  }

  function applyFilters(rows = AppState.data) {
    const f = AppState.filters;
    let out = [...rows];

    // Basic filters
    if (f.ha) out = out.filter(r => (r["TSV Heim/Ausw√§rts"] || '') === f.ha);
    if (f.teamLiga) {
      const [team, liga] = f.teamLiga.split('|');
      out = out.filter(r => (r.Team || '') === team && (r.Liga || '') === liga);
    }
    if (f.gegner) out = out.filter(r => (r.Gegner || '') === f.gegner);
    if (f.weekday) out = out.filter(r => (r.Wochentag || '') === f.weekday);

    // Quick date filters
    if (f.quick === 'today') {
      out = out.filter(r => isToday(r.Datum));
    } else if (f.quick === 'week') {
      const today = new Date();
      // Montag als Wochenstart
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - ((today.getDay()+6)%7));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      out = out.filter(r => {
        const gameDate = new Date(r.Datum);
        return gameDate >= startOfWeek && gameDate <= endOfWeek;
      });
    } else if (f.quick === 'month') {
      const today = new Date();
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      out = out.filter(r => {
        const gameDate = new Date(r.Datum);
        return gameDate >= startOfMonth && gameDate <= endOfMonth;
      });
    }
    
    // ‚ÄûVergangenes ausblenden‚Äú
    if (f.hidePast) {
      const today = new Date();
      today.setHours(0,0,0,0);
      out = out.filter(r => parseISO(r.Datum, r.Uhrzeit) >= today);
    }

    // Search filter
    if (f.search) {
      const searchTerm = f.search.toLowerCase();
      out = out.filter(r => {
        return (r.Gegner || '').toLowerCase().includes(searchTerm) ||
               (r.Liga || '').toLowerCase().includes(searchTerm) ||
               (r.Team || '').toLowerCase().includes(searchTerm) ||
               (r.Heim || '').toLowerCase().includes(searchTerm) ||
               (r.Ausw√§rts || '').toLowerCase().includes(searchTerm);
      });
    }

    return applySorting(out);
  }

  // ------ Table ------
  function renderTable(){
    const tbody = document.querySelector('#games tbody');
    tbody.innerHTML = '';
    const rows = AppState.filteredData;

    // Count same-day games for badge
    AppState.dateCount = rows.reduce((acc,r)=>{ acc[r.Datum]=(acc[r.Datum]||0)+1; return acc; }, {});

    let lastMonth = '';
    rows.forEach(r => {
      const mk = monthKey(r.Datum);
      if (mk !== lastMonth && lastMonth !== '') {
        const sep = document.createElement('tr');
        sep.className = 'month-sep';
        sep.innerHTML = `<td colspan="9"></td>`;
        tbody.appendChild(sep);
      }
      lastMonth = mk;

      const tr = document.createElement('tr');

      // Datum (+ Mehrfach-Badge)
      const tdDate = document.createElement('td');
      tdDate.className = 'date-cell';
      tdDate.style.cursor = 'pointer';
      const chev = document.createElement('span');
      chev.className = 'chev';
      chev.textContent = '‚ñ∏';
      tdDate.appendChild(chev);
      tdDate.appendChild(document.createTextNode(fmtDE(r.Datum)));
      const cnt = AppState.dateCount[r.Datum] || 0;
      if (cnt > 1) {
        const badge = document.createElement('span');
        badge.className = 'ms-badge' + (cnt === 2 ? ' two' : '');
        badge.textContent = String(cnt);
        badge.title = `${cnt} Spiele am Tag`;
        tdDate.appendChild(badge);
      }
      tr.appendChild(tdDate);

      // Wochentag / Uhrzeit
      const tdWd = document.createElement('td');
      tdWd.className = 'wd-cell';
      tdWd.textContent = r.Wochentag || '';
      tr.appendChild(tdWd);
      
      const tdTime = document.createElement('td');
      tdTime.className = 'time-cell';
      tdTime.textContent = r.Uhrzeit || '';
      tr.appendChild(tdTime);

      // Team
      const tdTeam = document.createElement('td');
      tdTeam.textContent = r.Team || '';
      tr.appendChild(tdTeam);

      // Heim / ‚Äì / Ausw√§rts
      const tdHeim = document.createElement('td');
      tdHeim.className = 'club-cell';
      tdHeim.textContent = r.Heim || '';
      tr.appendChild(tdHeim);

      const tdSep = document.createElement('td');
      tdSep.textContent = '‚Äì';
      tdSep.style.textAlign = 'center';
      tr.appendChild(tdSep);

      const tdAus = document.createElement('td');
      tdAus.className = 'club-cell';
      tdAus.textContent = r.Ausw√§rts || '';
      tr.appendChild(tdAus);

      // TSV Heim/Ausw√§rts
      const haTd = document.createElement('td');
      haTd.className = 'tsv-cell';
      const side = r["TSV Heim/Ausw√§rts"] || '';
      if (side === 'Heim') {
        haTd.innerHTML = `<span class="chip chip-heim">Heim</span>`;
      } else if (side === 'Ausw√§rts') {
        haTd.innerHTML = `<span class="chip chip-auswaerts">Ausw√§rts</span>`;
      }
      tr.appendChild(haTd);

      // Liga
      const tdLiga = document.createElement('td');
      tdLiga.className = 'liga-cell';
      tdLiga.textContent = r.Liga || '';
      tr.appendChild(tdLiga);

      tbody.appendChild(tr);
    });

    document.getElementById('emptyState').style.display = rows.length ? 'none' : 'block';
  }

  // ------ Sorting ------
  function handleSort(field) {
    if (AppState.currentSort.field === field) {
      AppState.currentSort.direction = AppState.currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      AppState.currentSort = { field, direction: 'asc' };
    }
    document.querySelectorAll('thead th.sortable').forEach(th => th.classList.remove('sort-asc','sort-desc'));
    const header = document.querySelector(`[data-sort="${field}"]`);
    if (header) header.classList.add(AppState.currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
    render();
  }

  // ------ Quick Filters ------
  function handleQuickFilter(type) {
    // reset visual
    document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
    // store quick type
    AppState.filters.quick = type || '';
    // map home/away
    if (type === 'home') {
      AppState.filters.ha = 'Heim';
      document.getElementById('ha').value = 'Heim';
    } else if (type === 'away') {
      AppState.filters.ha = 'Ausw√§rts';
      document.getElementById('ha').value = 'Ausw√§rts';
    }
    // date quick filters imply hidePast
    if (type === 'today' || type === 'week' || type === 'month') {
      AppState.filters.hidePast = true;
      document.getElementById('hidePast').checked = true;
    }
    // activate button
    const btn = document.querySelector(`[data-filter="${type}"]`);
    if (btn) btn.classList.add('active');
    render();
  }

  // ------ Search ------
  function updateSearchClear(){
    const v = document.getElementById('search').value;
    document.getElementById('searchClear').style.opacity = v ? 1 : 0;
  }
  const debouncedSearch = debounce((value)=>{
    AppState.filters.search = value.trim();
    updateSearchClear();
    render();
  }, 300);

  // ------ Stats ------
  function updateStats(rows) {
    const statsEl = document.getElementById('stats');
    const total = rows.length;
    const home = rows.filter(r => r["TSV Heim/Ausw√§rts"] === 'Heim').length;
    const away = rows.filter(r => r["TSV Heim/Ausw√§rts"] === 'Ausw√§rts').length;
    const teams = new Set(rows.map(r => r.Team)).size;
    
    statsEl.innerHTML = `
      <div class="stat">
        <div class="stat-value">${total}</div>
        <div class="stat-label">Spiele</div>
      </div>
      <div class="stat">
        <div class="stat-value">${home}</div>
        <div class="stat-label">Heimspiele</div>
      </div>
      <div class="stat">
        <div class="stat-value">${away}</div>
        <div class="stat-label">Ausw√§rtsspiele</div>
      </div>
      <div class="stat">
        <div class="stat-value">${teams}</div>
        <div class="stat-label">Teams aktiv</div>
      </div>
    `;
  }

  // ------ Export Functions ------
  function downloadPDF() { window.print(); }
  function exportICS() {
    const rows = AppState.filteredData;
    const pad = n => String(n).padStart(2, '0');
    const lines = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//TSV UG//Spiele//DE'
    ];
    rows.forEach(r=>{
      const dt = parseISO(r.Datum, r.Uhrzeit);
      const dtStart = `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;
      lines.push('BEGIN:VEVENT');
      lines.push(`DTSTART:${dtStart}`);
      lines.push(`SUMMARY:${r.Team}: ${r.Heim} ‚Äì ${r.Ausw√§rts} (${r.Liga})`);
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    const blob = new Blob([lines.join('\n')], {type:'text/calendar'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'tsv_spiele.ics';
    a.click();
  }
  function exportExcel() {
    const rows = AppState.filteredData;
    const header = ['Datum','Wochentag','Uhrzeit','Team','Heim','-','Ausw√§rts','TSV','Liga'];
    const csv = [header.join(';')].concat(rows.map(r=>[
      fmtDE(r.Datum), r.Wochentag, r.Uhrzeit, r.Team, r.Heim, '-', r.Ausw√§rts, r["TSV Heim/Ausw√§rts"]||'', r.Liga
    ].join(';'))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'tsv_spiele.csv';
    a.click();
  }

  function updateURL(){
    // optional: State in URL schreiben, aktuell nicht genutzt
  }

  function resetFilters() {
    AppState.filters = {
      quick: '',
      ha: '',
      teamLiga: '',
      gegner: '',
      weekday: '',
      hidePast: false,
      search: ''
    };
    ['ha', 'teamLiga', 'gegner', 'weekday', 'search'].forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('hidePast').checked = false;
    document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
    updateSearchClear();
    render();
  }

  // ------ Event Listeners ------
  function setupEventListeners() {
    // Filter events
    ['ha', 'teamLiga', 'gegner', 'weekday'].forEach(id => {
      document.getElementById(id).addEventListener('change', (e) => {
        AppState.filters[id] = e.target.value;
        render();
      });
    });
    document.getElementById('hidePast').addEventListener('change', (e) => { AppState.filters.hidePast = e.target.checked; render(); });

    // Search events
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', (e) => { debouncedSearch(e.target.value); });
    searchInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') { searchInput.value=''; AppState.filters.search=''; updateSearchClear(); render(); }});
    document.getElementById('searchClear').addEventListener('click', () => {
      searchInput.value = '';
      AppState.filters.search = '';
      updateSearchClear();
      render();
    });

    // Sort events
    document.querySelectorAll('thead th.sortable').forEach(th => {
      th.addEventListener('click', () => handleSort(th.getAttribute('data-sort')));
    });

    // Quick filter events
    document.querySelectorAll('.quick-filter').forEach(btn => {
      btn.addEventListener('click', () => handleQuickFilter(btn.getAttribute('data-filter')));
    });

    // Button events
    document.getElementById('btnPdf').addEventListener('click', downloadPDF);
    document.getElementById('btnIcs').addEventListener('click', exportICS);
    document.getElementById('btnExcel').addEventListener('click', exportExcel);
    document.getElementById('btnReset').addEventListener('click', resetFilters);
  }

  // ------ Initialization ------
  function init() { setupEventListeners(); loadData(); }
  init();
</script>
</body>
</html>
